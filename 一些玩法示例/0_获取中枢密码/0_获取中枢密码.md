# 自动获取小米中枢网关的登录密码


## 原理
1. 发post请求
2. 解析返回
3. 将返回直接粘贴到输入框中自动验证并跳转

## 一、Win / MacOS 平台
[实现效果win](https://v.douyin.com/p8sAPpB-mMI)
### 知识储备
1. 抓包软件的使用
2. 暴力猴扩展的使用

### 输入
#### 一个暴力猴脚本
[脚本源码](/极客版js脚本/1_monkey_get_xiaomi_passwd.md)

#### 一个抓包文件
<details>
<summary>post格式样例</summary>

```text
POST https://core.api.mijia.tech/app/home/rpc/105519308 HTTP/1.1

Host: core.api.mijia.tech
Content-Type: application/x-www-form-urlencoded
Accept: */*
Accept-Encoding: gzip, deflate, br
Cookie: PassportDeviceId=42A26ED8F68F26; locale=zh_cn; serviceToken=/RhWZBIZ0NVIreer0hDCo8G+Mvigej/B/vpqKDx49tE2qTUSFJvyVydx9rqMebW4446nqg5PLPgqlsuGcYtbT8QXsrVBri7/FdLg6u5GgoEP1v6FNMxdmIS+FROZyohi91CeZ1Ltuh9NlXRVifUMX93G43D1/rP8pw=; userId=2810003771; yetAnotherServiceToken=/RhWZBIZDxQd0NVIreer0hDCo8G+Mvigej/B/vpqKDx49tE2qTUSFJvyVydx9rqMebW44bq46nqg5PLPgqlsuGcYtbT8QXsrVBri7/FdLg6u5GgoEP1v6FNMxdmIS+FROZ2MOyohi91CeZ1Ltuh9NlXRVifUMX93G43D1/rP8pw=; PassportDeviceId=42A2611ED8F68F26; locale=zh_cn; serviceToken=/RhWZBIZDxQd0NVIreer0hDCo8G+Mvigej/B/vpqKDx49tE2qTUSFJvyVydx9rqMebW44bq46nqg5PLPgqlsuGcYtbT8QXsrVBri7/FdLg6u5GgoEP1v6FNMxdmIS+FROZ2MOyohi91CeZ1Ltuh9NlXRVifUMX93G43D1/rP8pw=; userId=2810003771; yetAnotherServiceToken=/RhWZBIZDxQd0NVIreer0hDCo8G+Mvigej/B/vpqKDx49tE2qTUSFJvyVydx9rqMebW44bq46nqg5PLPgqlsuGcYtbT8QXsrVBri7/FdLg6u5GgoEP1v6FNMxdmIS+FROZ2MOyohi91CeZ1Ltuh9NlXRVifUMX93G43D1/rP8pw=
Connection: keep-alive
Content-Length: 230
operate-common: _region=CN&_language=ZH_CN&_deviceId=47FB2362F162A91AD5666B6C0DBCD05F&_appVersion=9.6.202&_platform=1&_platformVersion=17.5.1
Accept-Language: zh-Hans;q=1
X-XIAOMI-PROTOCAL-FLAG-CLI: PROTOCAL-HTTP2
User-Agent: iOS-17.5.1-9.6.202-iPhone15,2--47FB2362F162ADB5B288FE36C0DBCD05F-2810003771-42A26D8F68F26-iPhone

_nonce=/////9nmMBsBtS0v&data=%7B%22id%22%3AC%22method%22%3A%22miIO.get_central_link_passcode%22%2C%22accey%22%3A%22IOS00026747c5acafc2%22%2C%22params%7B%7D%7D&signature=pJRhuyEK3o6K/%Rdr2zIl0LFG/5stfx3AsE71g%3D
```

</details>

1. url 
2. header 
3. body<br> 
三部分之间需要用**空行隔开**

### 使用步骤
1. 添加[暴力猴](../../极客版js脚本/1_monkey_get_xiaomi_passwd.js)脚本
2. 首次使用需要上传一个**抓包文件**

## 二、ios / ipadOS 平台
[实现效果](https://v.douyin.com/efV99u0Ulws)
### 知识储备
1. 抓包软件的使用
2. 快捷指令的使用
3. scriptable app的使用
4. safari浏览器的userscript扩展的使用

### 输入
#### 一个scriptable脚本
<details>
<summary>post_send.js脚本内容</summary>

```js
// Scriptable 脚本：自动获取极客动态密码（最终版）

// 获取快捷指令传入的文件路径 URL
let content = args.shortcutParameter;

// 兼容 Scriptable 的 UTF-8 字节长度计算函数
function utf8ByteLength(str) {
  let s = str.length;
  for (let i = str.length - 1; i >= 0; i--) {
    const code = str.charCodeAt(i);
    if (code > 0x7f && code <= 0x7ff) s++;
    else if (code > 0x7ff && code <= 0xffff) s += 2;
    if (code >= 0xDC00 && code <= 0xDFFF) i--; // 代理对
  }
  return s;
}

// 解析文件内容为 URL、Headers 和 Data
function parseContent(content) {
  const sections = content.split(/\r?\n\r?\n/);
  if (sections.length < 3) throw new Error("文件格式错误，需包含 URL、Headers、Body 三部分");

  const urlLine = sections[0].split(' ')[1];
  const url = urlLine.trim();

  const headers = {};
  const headerLines = sections[1].split(/\r?\n/);
  for (let line of headerLines) {
    const [key, value] = line.split(':');
    if (key && value) headers[key.trim()] = value.trim();
  }

  const dataLines = sections[2].split('&');
  const parsedData = {};
  for (let line of dataLines) {
    const [key, value] = line.split('=');
    if (key && value) {
      parsedData[decodeURIComponent(key)] = decodeURIComponent(value);
    }
  }

  const data = Object.entries(parsedData)
    .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
    .join('&');

  headers["Content-Length"] = String(utf8ByteLength(data));

  return { url, headers, data };
}

// 发 POST 请求并处理响应
async function sendPost(url, headers, data) {
  let req = new Request(url);
  req.method = "POST";
  req.headers = headers;
  req.body = data;

  try {
    let res = await req.loadJSON();
    if (!res.result || !res.result.passcode) throw new Error("响应中未找到 passcode");

    const passcode = res.result.passcode;
    Pasteboard.copyString(passcode);
    console.log("已复制 passcode:"+passcode);
    return passcode;
  } catch (err) {
    console.error("请求失败:", err);
    await new Alert().present("请求失败: " + err.message);
  }
}

// 主逻辑
try {
  const { url, headers, data } = parseContent(content);
  const passcode = await sendPost(url, headers, data);
  Script.setShortcutOutput(passcode);
} catch (e) {
  console.error("执行出错:", e);
}
```
</details>

#### 一个抓包文件
<details>
<summary>post格式样例</summary>

```text
POST https://core.api.mijia.tech/app/home/rpc/105519308 HTTP/1.1

Host: core.api.mijia.tech
Content-Type: application/x-www-form-urlencoded
Accept: */*
Accept-Encoding: gzip, deflate, br
Cookie: PassportDeviceId=42A26ED8F68F26; locale=zh_cn; serviceToken=/RhWZBIZ0NVIreer0hDCo8G+Mvigej/B/vpqKDx49tE2qTUSFJvyVydx9rqMebW4446nqg5PLPgqlsuGcYtbT8QXsrVBri7/FdLg6u5GgoEP1v6FNMxdmIS+FROZyohi91CeZ1Ltuh9NlXRVifUMX93G43D1/rP8pw=; userId=2810003771; yetAnotherServiceToken=/RhWZBIZDxQd0NVIreer0hDCo8G+Mvigej/B/vpqKDx49tE2qTUSFJvyVydx9rqMebW44bq46nqg5PLPgqlsuGcYtbT8QXsrVBri7/FdLg6u5GgoEP1v6FNMxdmIS+FROZ2MOyohi91CeZ1Ltuh9NlXRVifUMX93G43D1/rP8pw=; PassportDeviceId=42A2611ED8F68F26; locale=zh_cn; serviceToken=/RhWZBIZDxQd0NVIreer0hDCo8G+Mvigej/B/vpqKDx49tE2qTUSFJvyVydx9rqMebW44bq46nqg5PLPgqlsuGcYtbT8QXsrVBri7/FdLg6u5GgoEP1v6FNMxdmIS+FROZ2MOyohi91CeZ1Ltuh9NlXRVifUMX93G43D1/rP8pw=; userId=2810003771; yetAnotherServiceToken=/RhWZBIZDxQd0NVIreer0hDCo8G+Mvigej/B/vpqKDx49tE2qTUSFJvyVydx9rqMebW44bq46nqg5PLPgqlsuGcYtbT8QXsrVBri7/FdLg6u5GgoEP1v6FNMxdmIS+FROZ2MOyohi91CeZ1Ltuh9NlXRVifUMX93G43D1/rP8pw=
Connection: keep-alive
Content-Length: 230
operate-common: _region=CN&_language=ZH_CN&_deviceId=47FB2362F162A91AD5666B6C0DBCD05F&_appVersion=9.6.202&_platform=1&_platformVersion=17.5.1
Accept-Language: zh-Hans;q=1
X-XIAOMI-PROTOCAL-FLAG-CLI: PROTOCAL-HTTP2
User-Agent: iOS-17.5.1-9.6.202-iPhone15,2--47FB2362F162ADB5B288FE36C0DBCD05F-2810003771-42A26D8F68F26-iPhone

_nonce=/////9nmMBsBtS0v&data=%7B%22id%22%3AC%22method%22%3A%22miIO.get_central_link_passcode%22%2C%22accey%22%3A%22IOS00026747c5acafc2%22%2C%22params%7B%7D%7D&signature=pJRhuyEK3o6K/%Rdr2zIl0LFG/5stfx3AsE71g%3D
```

</details>

1. url 
2. header 
3. body<br> 
三部分之间需要用**空行隔开**

#### 一个快捷指令：
<img src="一些玩法示例/0_获取中枢密码/快捷指令.jpeg" style="max-width: 300px;">

#### 一个userscript脚本
<details>
<summary>auto_fill.js脚本内容</summary>

```js
// ==UserScript==
// @name        自动填充验证码
// @match       *://*/*
// @run-at      document-idle
// @grant       none
// ==/UserScript==

(async function() {

	const params = new URLSearchParams(location.search);
	const code = params.get('code');
  if (!code) return;

  const numbers = document.querySelectorAll('.pin-number.bg-normal');
  const numMap = {};
  numbers.forEach(el => {
    const val = el.textContent.trim();
    if (/^\d$/.test(val)) {
      numMap[val] = el;
    }
  });

  for (const digit of code) {
    if (numMap[digit]) {
      numMap[digit].click();
      await new Promise(r => setTimeout(r, 100));
    }
  }
  const delBtn = document.querySelector('div.pin-delete.bg-normal');
  if (delBtn) {
    delBtn.click();
    await new Promise(r => setTimeout(r, 100));
  }
  const lastDigit = code[code.length - 1];
  numMap[lastDigit].click();
})();
```
</details>

### 使用步骤
1. 快捷指令调用scriptable应用运行，输入**post格式**的文件，输出验证码
2. 快捷指令open极客版url，同时把**验证码**用?的方式传入参数
3. safari浏览器安装userscript脚本，负责将验证码自动填入
