# 自动获取小米中枢网关的登录密码


## 原理
1. 发post请求
2. 解析返回
3. 将返回直接粘贴到输入框中自动验证并跳转

## 一、Win / MacOS 平台
[实现效果win](https://v.douyin.com/p8sAPpB-mMI)
### 知识储备
1. 抓包软件的使用
2. 暴力猴扩展的使用

### 实现步骤
#### 1. 获取并安装这个暴力猴脚本
[脚本源码](/极客版js脚本/7_monkey_get_xiaomi_passwd_curl_version.md)

#### 2. 用抓包工具获取到post请求的curl命令
```bash
curl 'https://core.api.mijia.tech/app/home/rpc/1056522111'  -H 'Host: core.api.mijia.tech'  -H 'MIOT-REQUEST-MODEL: xiaomi.gateway.hub1'  -H 'Accept: */*'  -H 'Accept-Encoding: gzip, deflate, br'  -H 'Accept-Language: zh-Hans-CN;q=1, ja-CN;q=0.9, en-CN;q=0.8'  -H 'Content-Type: application/x-www-form-urlencoded'  -H 'Content-Length: 229'  -H 'domain-refer: core.api.mijia.tech'  -H 'Origin-From: MiHome'  -H 'operate-common: _region=CN&_language=ZH_CN&_deviceId=3DB5522359981095D868D56736354BDA8048E0F6&_appVersion=11.1.206&_platform=1&_platformVersion=26.2.1'  -H 'X-XIAOMI-PROTOCAL-FLAG-CLI: PROTOCAL-HTTP2'  -H 'User-Agent: iOS-26.2.1-11.1.206-iPhone17,1--3DB5522359381099D868D56736354BDA8048E0F6-1020449632-42A2611ED8968F26-iPhone'  -H 'Cookie: PassportDeviceId=42A2619ED8F68F26; locale=zh_cn; serviceToken=l9M2zDg79FeTkUcGygdSHGaPJ126qPL9VlzprAJY3dqSHe3OGRXDc1Qf1kxY1H9Dpzgwg6HSnRLn7r3wBGVt9IfSZexn8d3WWcuesFykxBuB43/+cd+qD4t/niqxoN1SPTINSzrX+s2+0UHmywdP1pbF8vyOX2TkGbsH9LkCnab4/AwgBd1OWeM0YzNcAVyOPlZr3nNeIvt+PMWnC3szzQ==; userId=1020499632; yetAnotherServiceToken=l9M2zDg79FeTkUcGygdSHGaPJ126qPL9VlzprAJY3dqSHe3OGRXDc1Qf1kxY1HiDpzgwg6HSnRLn7r3wBGVt9IfSZexn8d3WWcuesFykxBuB43/+cd+qD4t/niqxoN1SPTINSzrX+s2+0UHmywdP1pbF8vyOX2TkGbsHzLkCnab4/AwgBd1OWeM0YzNcAVyOPlZr3nNeIvt+PMWnC3szzQ==; PassportDeviceId=42A2611ED8F68F26; locale=zh_cn; serviceToken=l9M2zDg79FeTkUcGygdSHGaPJ126qPL9VlzprAJY3dqSHe3OGRXDc1Qf1kxY1HiDpzgwg6H9nRLn7r3wBGVt9IfSZexn8d3WWcuesFykxBuB43/+cd+qD4t/niqxoN1SPTINSzrX+s2+0UHmywdP1pbF8vyOX2TkGbsHz9kCnab4/AwgBd1OWeM0YzNcAVyOPlZr3nNeIvt+PMWnC3szzQ==; userId=1020449632; yetAnotherServiceToken=l9M2zDg79F9TkUcGygdSHGaPJ126qPL9VlzprAJY3dqSHe3OGRXDc1Qf1kxY1HiDpzgwg6HSnRLn7r3wBGVt9IfSZexn8d3WWcuesFykxBuB43/+cd+qD4t/niqxoN1SPTINSzrX+s2+0UHmywdP1pbF8vyOX2TkGbsHzLkCnab4/AwgBd1OWeM0YzNcAVyOPlZr3nNeIvt+PMWnC3szzQ=='  -H 'Connection: keep-alive'   --data '_nonce=//////NpOTEBwjQE&data=%7B%22id%22%3A57%2C%22method%22%3A%22miIO.get_central_link_passcode%22%2C%22accessKey%22%3A%22IOS00026747c5acafc2%22%2C%22params%22%3A%7B%7D%7D&signature=zYNnJWPZwJKZzUWB7Vv9r9D8gJgAS5ZWkPHS5E8OZEc%3D' 
```

#### 3. 打开极客版网页，并上传一次curl命令文件即可
#### 4. 每隔一段时间，需要重新获取curl命令并从网页上传

## 二、ios / ipadOS 平台
[实现效果](https://v.douyin.com/efV99u0Ulws)
### 知识储备
1. 抓包软件的使用
2. 快捷指令的使用
3. safari浏览器的userscript扩展的使用

### 实现步骤
#### 1. 用抓包工具获取到post请求的curl命令
```bash
curl 'https://core.api.mijia.tech/app/home/rpc/1056522111'  -H 'Host: core.api.mijia.tech'  -H 'MIOT-REQUEST-MODEL: xiaomi.gateway.hub1'  -H 'Accept: */*'  -H 'Accept-Encoding: gzip, deflate, br'  -H 'Accept-Language: zh-Hans-CN;q=1, ja-CN;q=0.9, en-CN;q=0.8'  -H 'Content-Type: application/x-www-form-urlencoded'  -H 'Content-Length: 229'  -H 'domain-refer: core.api.mijia.tech'  -H 'Origin-From: MiHome'  -H 'operate-common: _region=CN&_language=ZH_CN&_deviceId=3DB5522359981095D868D56736354BDA8048E0F6&_appVersion=11.1.206&_platform=1&_platformVersion=26.2.1'  -H 'X-XIAOMI-PROTOCAL-FLAG-CLI: PROTOCAL-HTTP2'  -H 'User-Agent: iOS-26.2.1-11.1.206-iPhone17,1--3DB5522359381099D868D56736354BDA8048E0F6-1020449632-42A2611ED8968F26-iPhone'  -H 'Cookie: PassportDeviceId=42A2619ED8F68F26; locale=zh_cn; serviceToken=l9M2zDg79FeTkUcGygdSHGaPJ126qPL9VlzprAJY3dqSHe3OGRXDc1Qf1kxY1H9Dpzgwg6HSnRLn7r3wBGVt9IfSZexn8d3WWcuesFykxBuB43/+cd+qD4t/niqxoN1SPTINSzrX+s2+0UHmywdP1pbF8vyOX2TkGbsH9LkCnab4/AwgBd1OWeM0YzNcAVyOPlZr3nNeIvt+PMWnC3szzQ==; userId=1020499632; yetAnotherServiceToken=l9M2zDg79FeTkUcGygdSHGaPJ126qPL9VlzprAJY3dqSHe3OGRXDc1Qf1kxY1HiDpzgwg6HSnRLn7r3wBGVt9IfSZexn8d3WWcuesFykxBuB43/+cd+qD4t/niqxoN1SPTINSzrX+s2+0UHmywdP1pbF8vyOX2TkGbsHzLkCnab4/AwgBd1OWeM0YzNcAVyOPlZr3nNeIvt+PMWnC3szzQ==; PassportDeviceId=42A2611ED8F68F26; locale=zh_cn; serviceToken=l9M2zDg79FeTkUcGygdSHGaPJ126qPL9VlzprAJY3dqSHe3OGRXDc1Qf1kxY1HiDpzgwg6H9nRLn7r3wBGVt9IfSZexn8d3WWcuesFykxBuB43/+cd+qD4t/niqxoN1SPTINSzrX+s2+0UHmywdP1pbF8vyOX2TkGbsHz9kCnab4/AwgBd1OWeM0YzNcAVyOPlZr3nNeIvt+PMWnC3szzQ==; userId=1020449632; yetAnotherServiceToken=l9M2zDg79F9TkUcGygdSHGaPJ126qPL9VlzprAJY3dqSHe3OGRXDc1Qf1kxY1HiDpzgwg6HSnRLn7r3wBGVt9IfSZexn8d3WWcuesFykxBuB43/+cd+qD4t/niqxoN1SPTINSzrX+s2+0UHmywdP1pbF8vyOX2TkGbsHzLkCnab4/AwgBd1OWeM0YzNcAVyOPlZr3nNeIvt+PMWnC3szzQ=='  -H 'Connection: keep-alive'   --data '_nonce=//////NpOTEBwjQE&data=%7B%22id%22%3A57%2C%22method%22%3A%22miIO.get_central_link_passcode%22%2C%22accessKey%22%3A%22IOS00026747c5acafc2%22%2C%22params%22%3A%7B%7D%7D&signature=zYNnJWPZwJKZzUWB7Vv9r9D8gJgAS5ZWkPHS5E8OZEc%3D' 
```


#### 2. 在应用商店里安装 a-shell工具

#### 3. 快捷指令中通过a-shell执行curl命令：
<img src="一些玩法示例/0_获取中枢密码/快捷指令.jpeg" style="max-width: 300px;">

#### 给safari浏览器安装userscript，并添加脚本
<details>
<summary>auto_fill.js脚本内容</summary>

```js
// ==UserScript==
// @name        自动填充验证码
// @match       *://*/*
// @run-at      document-idle
// @grant       none
// ==/UserScript==

(async function() {

	const params = new URLSearchParams(location.search);
	const code = params.get('code');
  if (!code) return;

  const numbers = document.querySelectorAll('.pin-number.bg-normal');
  const numMap = {};
  numbers.forEach(el => {
    const val = el.textContent.trim();
    if (/^\d$/.test(val)) {
      numMap[val] = el;
    }
  });

  for (const digit of code) {
    if (numMap[digit]) {
      numMap[digit].click();
      await new Promise(r => setTimeout(r, 100));
    }
  }
  const delBtn = document.querySelector('div.pin-delete.bg-normal');
  if (delBtn) {
    delBtn.click();
    await new Promise(r => setTimeout(r, 100));
  }
  const lastDigit = code[code.length - 1];
  numMap[lastDigit].click();
})();
```
</details>

#### 4. 总快捷指令：
<img src="一些玩法示例/0_获取中枢密码/快捷指令2.jpeg" style="max-width: 300px;">